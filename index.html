<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<title>Dengue – Brasil</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

<style>
body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto;
  background:#f4f4f4;
  color:#111;
}
header{
  padding:14px 20px;
  background:#fff;
  border-bottom:1px solid #ddd;
}
main{
  max-width:900px;
  margin:auto;
  padding:20px;
}
.card{
  background:#fff;
  border:1px solid #ddd;
  border-radius:8px;
  padding:16px;
}
#error{
  margin-top:10px;
  padding:10px;
  background:#fee;
  border:1px solid #f99;
  color:#900;
  display:none;
  white-space:pre-wrap;
  font-size:13px;
}
</style>
</head>

<body>

<header>
  <h2>Dengue – Brasil (casos totais por ano)</h2>
</header>

<main>
  <div class="card">
    <canvas id="grafico"></canvas>
    <div id="error"></div>
  </div>
</main>

<script>
const errorBox = document.getElementById("error");
function erro(msg){
  errorBox.style.display = "block";
  errorBox.textContent = msg;
  console.error(msg);
}

Papa.parse("dados-dengue-estados.csv",{
  download: true,
  header: true,
  skipEmptyLines: true,
  delimiter: "", // ← deixa o Papa descobrir
  complete: function(res){

    if(!res.data || res.data.length === 0){
      erro("CSV lido, mas sem dados.");
      return;
    }

    // mostra as colunas encontradas (diagnóstico)
    console.log("Colunas:", Object.keys(res.data[0]));

    // primeira coluna = UF
    const colUF = Object.keys(res.data[0])[0];

    // tenta achar TOTAL
    const total = res.data.find(r =>
      r[colUF] && r[colUF].toString().toLowerCase().includes("total")
    );

    if(!total){
      erro(
        "Não encontrei a linha TOTAL.\n\n" +
        "Primeiras linhas encontradas:\n\n" +
        JSON.stringify(res.data.slice(0,5), null, 2)
      );
      return;
    }

    // anos = colunas numéricas
    const anos = Object.keys(total).filter(c => /^\d{4}$/.test(c));

    if(anos.length === 0){
      erro(
        "Linha TOTAL encontrada, mas não achei colunas de ano.\n\n" +
        JSON.stringify(total, null, 2)
      );
      return;
    }

    const valores = anos.map(a => {
      const v = total[a];
      return v ? Number(v.replace(/\./g,"")) : 0;
    });

    new Chart(document.getElementById("grafico"),{
      type:"line",
      data:{
        labels:anos,
        datasets:[{
          label:"Brasil – casos de dengue",
          data:valores,
          borderColor:"#333",
          backgroundColor:"rgba(0,0,0,.08)",
          tension:0.3,
          pointRadius:3
        }]
      },
      options:{
        responsive:true,
        scales:{
          y:{
            ticks:{ callback:v => v.toLocaleString() }
          }
        }
      }
    });
  },
  error: function(err){
    erro("Erro ao ler CSV: " + err);
  }
});
</script>

</body>
</html>
